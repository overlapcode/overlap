---
import Layout from '@layouts/Layout.astro';
import { Header } from '@components/Header';
import { SessionDetail } from '@components/SessionDetail';
import { getSessionData } from '@lib/auth/session';
import { ensureMigrated } from '@lib/db/migrate';

const { id } = Astro.params;
if (!id) {
  return Astro.redirect('/');
}

let sessionData = null;

if (Astro.locals.runtime?.env?.DB) {
  const db = Astro.locals.runtime.env.DB;
  await ensureMigrated(db);
  sessionData = await getSessionData(Astro.cookies, db);
}

if (!sessionData) {
  return Astro.redirect('/');
}

const teamName = sessionData.teamName;
---

<Layout title="Session Detail">
  <Header teamName={teamName} client:load />

  <main class="container" style="padding-top: var(--space-xl); padding-bottom: var(--space-xl);">
    <div style="width: 100%; max-width: 800px; margin: 0 auto;">
      <div style="margin-bottom: var(--space-lg);">
        <a href="/" class="footer-link" style="font-size: 0.875rem;">‚Üê Back to Timeline</a>
      </div>
      <SessionDetail sessionId={id} client:load />
    </div>
  </main>
</Layout>
