---
import Layout from '@layouts/Layout.astro';
import { Header } from '@components/Header';
import { RepoActivity } from '@components/RepoActivity';
import { getSessionUser } from '@lib/auth/session';
import { ensureMigrated } from '@lib/db/migrate';

let sessionData = null;
let repoName = 'Repository';
const repoId = Astro.params.id;

if (Astro.locals.runtime?.env?.DB) {
  const db = Astro.locals.runtime.env.DB;
  await ensureMigrated(db);
  sessionData = await getSessionUser(Astro.cookies, db);

  if (sessionData && repoId) {
    const repo = await db
      .prepare('SELECT name FROM repos WHERE id = ? AND team_id = ?')
      .bind(repoId, sessionData.team.id)
      .first<{ name: string }>();

    if (repo) {
      repoName = repo.name;
    } else {
      return Astro.redirect('/repos');
    }
  }
}

if (!sessionData) {
  return Astro.redirect('/');
}

const teamName = sessionData.team.name;
const userName = sessionData.user.name;
---

<Layout title={repoName}>
  <Header teamName={teamName} userName={userName} client:load />

  <main class="container" style="padding-top: var(--space-xl); padding-bottom: var(--space-xl);">
    <div style="width: 100%; max-width: 800px; margin: 0 auto;">
      <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-lg);">
        <a href="/repos" class="footer-link" style="font-size: 0.875rem;">‚Üê Repositories</a>
      </div>
      <h1 style="font-size: 1.25rem; font-family: var(--font-mono); margin: 0 0 var(--space-lg) 0; color: var(--text-primary);">
        {repoName}
      </h1>
      <RepoActivity repoId={repoId!} client:load />
    </div>
  </main>
</Layout>
