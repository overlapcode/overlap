---
import Layout from '@layouts/Layout.astro';
import { Header } from '@components/Header';
---

<Layout title="Plugin Logs">
  <Header client:load />

  <main class="container" style="padding-top: var(--space-xl); padding-bottom: var(--space-xl);">
    <div style="width: 100%; max-width: 900px; margin: 0 auto;">
      <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-xl);">
        <a href="/settings" class="text-muted" style="text-decoration: none;">‚Üê Back</a>
        <h1 style="font-size: 1.5rem; margin: 0;">Plugin Logs</h1>
      </div>

      <!-- Filters -->
      <div class="filters-bar">
        <div class="filter-group">
          <label for="user-filter">User</label>
          <select id="user-filter">
            <option value="">All Users</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="level-filter">Level</label>
          <select id="level-filter">
            <option value="">All Levels</option>
            <option value="ERROR">Error</option>
            <option value="WARN">Warning</option>
            <option value="INFO">Info</option>
          </select>
        </div>
        <button id="refresh-btn" class="btn-action">Refresh</button>
      </div>

      <!-- Stats -->
      <div id="stats-bar" class="stats-bar" style="display: none;">
        <span id="total-count">0 logs</span>
        <span class="stats-separator">‚Ä¢</span>
        <span id="showing-count">Showing 0</span>
      </div>

      <!-- Logs list -->
      <div id="logs-list">
        <div class="loading-state">
          <img src="/loading.gif" alt="Loading" width="48" height="48" style="opacity: 0.8;" />
        </div>
      </div>

      <!-- Pagination -->
      <div id="pagination" class="pagination" style="display: none;">
        <button id="load-more" class="btn-action">Load More</button>
      </div>

      <div id="toast" class="toast"></div>
    </div>
  </main>
</Layout>

<style is:global>
  .loading-state {
    color: var(--text-secondary);
    padding: var(--space-lg);
    text-align: center;
  }

  .filters-bar {
    display: flex;
    gap: var(--space-md);
    align-items: flex-end;
    margin-bottom: var(--space-lg);
    padding: var(--space-md);
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: 8px;
    flex-wrap: wrap;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .filter-group label {
    font-size: 0.7rem;
    font-weight: 500;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .filter-group select {
    padding: 8px 12px;
    font-size: 0.85rem;
    border: 1px solid var(--border-default);
    border-radius: 4px;
    background: var(--bg-elevated);
    color: var(--text-primary);
    cursor: pointer;
    min-width: 140px;
  }

  .filter-group select:focus {
    outline: none;
    border-color: var(--accent-blue);
  }

  .stats-bar {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-bottom: var(--space-md);
    padding-left: 4px;
  }

  .stats-separator {
    margin: 0 8px;
    opacity: 0.5;
  }

  .log-entry {
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: 8px;
    margin-bottom: 8px;
    overflow: hidden;
  }

  .log-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    cursor: pointer;
    transition: background 0.15s ease;
  }

  .log-header:hover {
    background: var(--bg-elevated);
  }

  .log-level {
    font-size: 0.65rem;
    font-weight: 600;
    padding: 3px 8px;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    flex-shrink: 0;
  }

  .log-level.error {
    background: rgba(229, 115, 115, 0.15);
    color: #e57373;
    border: 1px solid rgba(229, 115, 115, 0.3);
  }

  .log-level.warn {
    background: rgba(255, 193, 7, 0.15);
    color: #ffc107;
    border: 1px solid rgba(255, 193, 7, 0.3);
  }

  .log-level.info {
    background: rgba(106, 155, 204, 0.15);
    color: var(--accent-blue);
    border: 1px solid rgba(106, 155, 204, 0.3);
  }

  .log-level.debug {
    background: var(--bg-elevated);
    color: var(--text-muted);
    border: 1px solid var(--border-default);
  }

  .log-message {
    flex: 1;
    font-size: 0.85rem;
    color: var(--text-primary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    min-width: 0;
  }

  .log-meta {
    display: flex;
    gap: 16px;
    font-size: 0.75rem;
    color: var(--text-muted);
    flex-shrink: 0;
  }

  .log-user {
    color: var(--text-secondary);
    font-weight: 500;
  }

  .log-hook {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    background: var(--bg-elevated);
    padding: 2px 6px;
    border-radius: 3px;
  }

  .log-time {
    font-family: var(--font-mono);
    font-size: 0.7rem;
  }

  .log-expand {
    color: var(--text-muted);
    transition: transform 0.2s ease;
  }

  .log-entry.expanded .log-expand {
    transform: rotate(180deg);
  }

  .log-details {
    display: none;
    padding: 0 16px 16px;
    border-top: 1px solid var(--border-subtle);
    margin-top: 0;
  }

  .log-entry.expanded .log-details {
    display: block;
  }

  .log-detail-section {
    margin-top: 12px;
  }

  .log-detail-label {
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 6px;
  }

  .log-detail-content {
    font-family: var(--font-mono);
    font-size: 0.8rem;
    background: var(--bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: 4px;
    padding: 12px;
    overflow-x: auto;
    white-space: pre-wrap;
    word-break: break-word;
    color: var(--text-secondary);
    max-height: 300px;
    overflow-y: auto;
  }

  .log-error-content {
    color: #e57373;
  }

  .pagination {
    text-align: center;
    padding: var(--space-lg) 0;
  }

  .btn-action {
    font-size: 0.8rem;
    font-weight: 500;
    padding: 8px 16px;
    border-radius: 4px;
    border: 1px solid var(--border-default);
    background: var(--bg-elevated);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .btn-action:hover {
    background: var(--bg-surface);
    border-color: var(--text-muted);
    color: var(--text-primary);
  }

  .empty-state {
    text-align: center;
    padding: var(--space-xl);
    color: var(--text-muted);
  }

  .empty-state-icon {
    font-size: 2rem;
    margin-bottom: var(--space-md);
    opacity: 0.5;
  }

  .toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--bg-elevated);
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 0.875rem;
    display: none;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  .toast.success {
    border: 1px solid var(--accent-green);
    color: var(--accent-green);
  }

  .toast.error {
    border: 1px solid var(--accent-orange);
    color: var(--accent-orange);
  }

  @media (max-width: 600px) {
    .log-meta {
      display: none;
    }

    .filters-bar {
      flex-direction: column;
      align-items: stretch;
    }

    .filter-group select {
      width: 100%;
    }
  }
</style>

<script>
  type PluginLog = {
    id: string;
    user_id: string;
    user_name: string;
    level: 'DEBUG' | 'INFO' | 'WARN' | 'ERROR';
    hook: string | null;
    session_id: string | null;
    message: string;
    data: string | null;
    error: string | null;
    created_at: string;
  };

  type User = {
    id: string;
    name: string;
  };

  const toast = document.getElementById('toast')!;
  const logsContainer = document.getElementById('logs-list')!;
  const userFilter = document.getElementById('user-filter') as unknown as HTMLSelectElement;
  const levelFilter = document.getElementById('level-filter') as unknown as HTMLSelectElement;
  const refreshBtn = document.getElementById('refresh-btn')!;
  const statsBar = document.getElementById('stats-bar')!;
  const totalCount = document.getElementById('total-count')!;
  const showingCount = document.getElementById('showing-count')!;
  const pagination = document.getElementById('pagination')!;
  const loadMoreBtn = document.getElementById('load-more')!;

  let currentLogs: PluginLog[] = [];
  let currentOffset = 0;
  const LIMIT = 50;

  function showToast(message: string, isError = true) {
    toast.textContent = message;
    toast.className = `toast ${isError ? 'error' : 'success'}`;
    toast.style.display = 'block';
    setTimeout(() => {
      toast.style.display = 'none';
    }, 4000);
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function formatTime(isoString: string): string {
    const date = new Date(isoString);
    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffMins = Math.floor(diffMs / 60000);

    if (diffMins < 1) return 'just now';
    if (diffMins < 60) return `${diffMins}m ago`;

    const diffHours = Math.floor(diffMins / 60);
    if (diffHours < 24) return `${diffHours}h ago`;

    const diffDays = Math.floor(diffHours / 24);
    if (diffDays < 7) return `${diffDays}d ago`;

    return date.toLocaleDateString();
  }

  function formatJson(jsonString: string | null): string {
    if (!jsonString) return '';
    try {
      const parsed = JSON.parse(jsonString);
      return JSON.stringify(parsed, null, 2);
    } catch {
      return jsonString;
    }
  }

  async function loadLogs(reset = true) {
    if (reset) {
      currentOffset = 0;
      currentLogs = [];
      logsContainer.innerHTML = '<div class="loading-state"><img src="/loading.gif" alt="Loading" width="48" height="48" style="opacity: 0.8;" /></div>';
    }

    const userId = userFilter.value;
    const level = levelFilter.value;

    try {
      const params = new URLSearchParams();
      if (userId) params.set('user_id', userId);
      if (level) params.set('level', level);
      params.set('limit', String(LIMIT));
      params.set('offset', String(currentOffset));

      const response = await fetch(`/api/v1/admin/logs?${params}`);
      const result = await response.json() as {
        data?: {
          logs: PluginLog[];
          total: number;
          hasMore: boolean;
          users: User[];
        };
        error?: string;
      };

      if (!response.ok) {
        if (response.status === 403) {
          logsContainer.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üîí</div>
              <p>Admin access required to view logs.</p>
            </div>
          `;
          return;
        }
        throw new Error(result.error || 'Failed to load logs');
      }

      const { logs, total, hasMore, users } = result.data!;

      // Populate user filter (only on first load)
      if (reset && users.length > 0) {
        const currentValue = userFilter.value;
        userFilter.innerHTML = '<option value="">All Users</option>' +
          users.map(u => `<option value="${u.id}">${escapeHtml(u.name)}</option>`).join('');
        userFilter.value = currentValue;
      }

      currentLogs = reset ? logs : [...currentLogs, ...logs];
      currentOffset += logs.length;

      renderLogs();

      // Update stats
      statsBar.style.display = 'block';
      totalCount.textContent = `${total} log${total !== 1 ? 's' : ''}`;
      showingCount.textContent = `Showing ${currentLogs.length}`;

      // Update pagination
      pagination.style.display = hasMore ? 'block' : 'none';

    } catch (error) {
      if (reset) {
        logsContainer.innerHTML = `<div class="loading-state" style="color: var(--accent-orange);">${error instanceof Error ? error.message : 'Failed to load logs'}</div>`;
      } else {
        showToast(error instanceof Error ? error.message : 'Failed to load more logs');
      }
    }
  }

  function renderLogs() {
    if (currentLogs.length === 0) {
      logsContainer.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üìã</div>
          <p>No logs found matching your filters.</p>
        </div>
      `;
      return;
    }

    logsContainer.innerHTML = currentLogs.map(log => renderLogEntry(log)).join('');
  }

  function renderLogEntry(log: PluginLog): string {
    const levelClass = log.level.toLowerCase();
    const safeMessage = escapeHtml(log.message);
    const safeUser = escapeHtml(log.user_name);
    const timeStr = formatTime(log.created_at);

    let detailsHtml = '';

    if (log.data) {
      const formattedData = formatJson(log.data);
      detailsHtml += `
        <div class="log-detail-section">
          <div class="log-detail-label">Data</div>
          <div class="log-detail-content">${escapeHtml(formattedData)}</div>
        </div>
      `;
    }

    if (log.error) {
      const errorData = JSON.parse(log.error);
      detailsHtml += `
        <div class="log-detail-section">
          <div class="log-detail-label">Error</div>
          <div class="log-detail-content log-error-content">${escapeHtml(errorData.type)}: ${escapeHtml(errorData.message)}${errorData.traceback ? '\n\n' + escapeHtml(errorData.traceback) : ''}</div>
        </div>
      `;
    }

    const hasDetails = log.data || log.error;

    return `
      <div class="log-entry" data-id="${log.id}">
        <div class="log-header" onclick="toggleLog('${log.id}')">
          <span class="log-level ${levelClass}">${log.level}</span>
          <span class="log-message">${safeMessage}</span>
          <div class="log-meta">
            <span class="log-user">${safeUser}</span>
            ${log.hook ? `<span class="log-hook">${escapeHtml(log.hook)}</span>` : ''}
            <span class="log-time">${timeStr}</span>
          </div>
          ${hasDetails ? '<span class="log-expand">‚ñº</span>' : ''}
        </div>
        ${hasDetails ? `<div class="log-details">${detailsHtml}</div>` : ''}
      </div>
    `;
  }

  function toggleLog(id: string) {
    const entry = document.querySelector(`.log-entry[data-id="${id}"]`);
    if (entry) {
      entry.classList.toggle('expanded');
    }
  }

  // Event listeners
  userFilter.addEventListener('change', () => loadLogs(true));
  levelFilter.addEventListener('change', () => loadLogs(true));
  refreshBtn.addEventListener('click', () => loadLogs(true));
  loadMoreBtn.addEventListener('click', () => loadLogs(false));

  // Expose toggle function to window
  (window as unknown as { toggleLog: typeof toggleLog }).toggleLog = toggleLog;

  // Initial load
  loadLogs();
</script>
