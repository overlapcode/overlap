---
import Layout from '@layouts/Layout.astro';
import { Header } from '@components/Header';
---

<Layout title="Repositories">
  <Header client:load />

  <main class="container" style="padding-top: var(--space-xl); padding-bottom: var(--space-xl);">
    <div style="max-width: 800px; margin: 0 auto;">
      <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-xl);">
        <a href="/settings" class="text-muted" style="text-decoration: none;">‚Üê Back</a>
        <h1 style="font-size: 1.5rem;">Repositories</h1>
      </div>

      <div id="info-box" class="card" style="margin-bottom: var(--space-lg); background: var(--bg-elevated);">
        <p class="text-secondary" style="font-size: 0.875rem;">
          Loading...
        </p>
      </div>

      <div id="repos-list" class="card">
        <p class="text-secondary">Loading...</p>
      </div>

      <!-- Toast for error messages -->
      <div id="toast" style="
        position: fixed;
        bottom: var(--space-lg);
        left: 50%;
        transform: translateX(-50%);
        background: var(--bg-elevated);
        border: 1px solid var(--accent-orange);
        color: var(--accent-orange);
        padding: var(--space-sm) var(--space-lg);
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        display: none;
        z-index: 1000;
      "></div>
    </div>
  </main>
</Layout>

<style>
  .repo-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-md) 0;
    border-bottom: 1px solid var(--border-subtle);
  }

  .repo-row:last-child {
    border-bottom: none;
  }

  .repo-info {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .repo-name {
    font-weight: 500;
    font-family: var(--font-mono);
  }

  .repo-url {
    font-size: 0.75rem;
    color: var(--text-muted);
    font-family: var(--font-mono);
  }

  .visibility-toggle {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }
</style>

<script>
  type Repo = {
    id: string;
    name: string;
    remote_url: string | null;
    is_public: boolean;
  };

  const toast = document.getElementById('toast') as HTMLDivElement;
  const infoBox = document.getElementById('info-box') as HTMLDivElement;
  let isAdmin = false;

  function showToast(message: string) {
    toast.textContent = message;
    toast.style.display = 'block';
    setTimeout(() => {
      toast.style.display = 'none';
    }, 4000);
  }

  async function loadRepos() {
    const container = document.getElementById('repos-list') as HTMLDivElement;

    try {
      const response = await fetch('/api/v1/admin/repos');
      const result = await response.json() as { data?: { repos: Repo[], is_admin: boolean }, error?: string };

      if (!response.ok) {
        throw new Error(result.error || 'Failed to load repositories');
      }

      const repos = result.data?.repos || [];
      isAdmin = result.data?.is_admin ?? false;

      // Update info box based on role
      if (isAdmin) {
        infoBox.innerHTML = `<p class="text-secondary" style="font-size: 0.875rem;">
          As an admin, you can see all repositories connected to the team.
          Repositories are automatically registered when team members work in them.
          You can toggle visibility for each repository.
        </p>`;
      } else {
        infoBox.innerHTML = `<p class="text-secondary" style="font-size: 0.875rem;">
          These are the repositories you've worked on with the Overlap plugin.
          Repositories are automatically registered when you start a session in them.
        </p>`;
      }

      if (repos.length === 0) {
        const emptyMessage = isAdmin
          ? 'No repositories tracked yet. They will appear here when team members start working.'
          : 'No repositories tracked yet. They will appear here when you start working with the Overlap plugin.';
        container.innerHTML = `<p class="text-secondary">${emptyMessage}</p>`;
        return;
      }

      container.innerHTML = repos.map((repo) => `
        <div class="repo-row" data-repo-id="${repo.id}">
          <div class="repo-info">
            <span class="repo-name">${repo.name}</span>
            <span class="repo-url">${repo.remote_url || '(local only)'}</span>
          </div>
          ${isAdmin ? `
          <div class="visibility-toggle" style="opacity: 0.5;">
            <label style="display: flex; align-items: center; gap: var(--space-xs); cursor: not-allowed; font-size: 0.875rem;" title="Coming soon">
              <input
                type="checkbox"
                disabled
                style="width: 16px; height: 16px; cursor: not-allowed;"
              />
              <span class="text-secondary">Public</span>
              <span style="font-size: 0.6rem; color: var(--text-muted);">(soon)</span>
            </label>
          </div>
          ` : ''}
        </div>
      `).join('');
    } catch (error) {
      container.innerHTML = `<p style="color: var(--accent-orange);">${error instanceof Error ? error.message : 'Failed to load repositories'}</p>`;
      infoBox.innerHTML = '';
    }
  }

  async function toggleVisibility(repoId: string, isPublic: boolean) {
    try {
      const response = await fetch(`/api/v1/admin/repos/${repoId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_public: isPublic }),
      });

      if (!response.ok) {
        const result = await response.json() as { error?: string };
        throw new Error(result.error || 'Failed to update repository');
      }
    } catch (error) {
      showToast(error instanceof Error ? error.message : 'Failed to update repository');
      loadRepos(); // Reload to reset state
    }
  }

  // Make function global
  (window as unknown as { toggleVisibility: typeof toggleVisibility }).toggleVisibility = toggleVisibility;

  // Load repos on page load
  loadRepos();
</script>
