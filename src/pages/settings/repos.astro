---
import Layout from '@layouts/Layout.astro';
import { Header } from '@components/Header';
---

<Layout title="Repositories">
  <Header client:load />

  <main class="container" style="padding-top: var(--space-xl); padding-bottom: var(--space-xl);">
    <div style="width: 100%; max-width: 700px; margin: 0 auto;">
      <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-xl);">
        <a href="/settings" class="text-muted" style="text-decoration: none;">‚Üê Back</a>
        <h1 style="font-size: 1.5rem; margin: 0;">Repositories</h1>
      </div>

      <div id="repos-list">
        <div class="loading-state">
          <img src="/loading.gif" alt="Loading" width="48" height="48" style="opacity: 0.8;" />
        </div>
      </div>

    </div>
  </main>
</Layout>

<style is:global>
  .loading-state {
    color: var(--text-secondary);
    padding: var(--space-lg);
    text-align: center;
  }

  .section-header {
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 12px;
    padding-left: 4px;
  }

  .repos-section {
    margin-bottom: 32px;
  }

  .repo-card-link {
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .repo-card-link:hover .repo-card {
    border-color: var(--border-active);
  }

  .repo-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: 8px;
    padding: 16px 20px;
    margin-bottom: 8px;
  }

  .repo-card-inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
  }

  .repo-details {
    flex: 1;
    min-width: 0;
  }

  .repo-name {
    font-weight: 500;
    font-size: 0.95rem;
    color: var(--text-primary);
    font-family: var(--font-mono);
    margin-bottom: 2px;
  }

  .repo-url {
    font-size: 0.75rem;
    color: var(--text-muted);
    font-family: var(--font-mono);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .repo-description {
    font-size: 0.8rem;
    color: var(--text-secondary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .info-box {
    margin-top: 24px;
    padding: 16px;
    background: var(--bg-elevated);
    border: 1px solid var(--border-default);
    border-radius: 8px;
    text-align: center;
  }

  .info-box p {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin: 0;
    line-height: 1.5;
  }

  .empty-state {
    text-align: center;
    padding: var(--space-xl);
    color: var(--text-secondary);
  }

  .empty-state-icon {
    font-size: 2rem;
    margin-bottom: var(--space-md);
    opacity: 0.5;
  }

  @media (max-width: 500px) {
    .repo-card-inner {
      flex-wrap: wrap;
    }

    .repo-details {
      width: 100%;
      margin-bottom: 8px;
    }
  }
</style>

<script>
  type Repo = {
    id: string;
    name: string;
    display_name: string | null;
    description: string | null;
    created_at: string;
  };

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  async function loadRepos() {
    const container = document.getElementById('repos-list') as HTMLDivElement;

    try {
      const response = await fetch('/api/v1/admin/repos');
      const result = await response.json() as { data?: { repos: Repo[], is_admin: boolean }, error?: string };

      if (!response.ok) {
        throw new Error(result.error || 'Failed to load repositories');
      }

      const repos = result.data?.repos || [];

      if (repos.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìÇ</div>
            <p style="margin-bottom: var(--space-sm);">No repositories tracked yet</p>
            <p class="text-muted" style="font-size: 0.8rem;">
              Repositories appear here automatically when team members<br>
              start working with the tracer running.
            </p>
          </div>
        `;
        return;
      }

      // Sort repos alphabetically by display name or name
      const sortedRepos = repos.sort((a, b) => {
        const aName = a.display_name || a.name;
        const bName = b.display_name || b.name;
        return aName.localeCompare(bName);
      });

      let html = `<div class="repos-section">
        <div class="section-header">Repositories (${sortedRepos.length})</div>
        ${sortedRepos.map(repo => renderRepoCard(repo)).join('')}
      </div>`;

      html += `<div class="info-box">
        <p>Repositories are automatically registered when team members<br>work in them with the tracer running.</p>
      </div>`;

      container.innerHTML = html;
    } catch (error) {
      container.innerHTML = `<div class="loading-state" style="color: var(--accent-orange);">${error instanceof Error ? error.message : 'Failed to load repositories'}</div>`;
    }
  }

  function renderRepoCard(repo: Repo): string {
    const displayName = repo.display_name || repo.name;
    const safeName = escapeHtml(displayName);
    const safeDescription = repo.description ? escapeHtml(repo.description) : null;

    return `<a href="/repo/${repo.id}" class="repo-card-link">
      <div class="repo-card">
        <div class="repo-card-inner">
          <div class="repo-details">
            <div class="repo-name">${safeName}</div>
            ${safeDescription ? `<div class="repo-description">${safeDescription}</div>` : `<div class="repo-url">${escapeHtml(repo.name)}</div>`}
          </div>
        </div>
      </div>
    </a>`;
  }

  loadRepos();
</script>
