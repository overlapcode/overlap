---
import Layout from '@layouts/Layout.astro';
import { Header } from '@components/Header';
---

<Layout title="Repositories">
  <Header client:load />

  <main class="container" style="padding-top: var(--space-xl); padding-bottom: var(--space-xl);">
    <div style="max-width: 800px; margin: 0 auto;">
      <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-xl);">
        <a href="/settings" class="text-muted" style="text-decoration: none;">‚Üê Back</a>
        <h1 style="font-size: 1.5rem;">Repositories</h1>
      </div>

      <div class="card" style="margin-bottom: var(--space-lg); background: var(--bg-elevated);">
        <p class="text-secondary" style="font-size: 0.875rem;">
          Repositories are automatically registered when team members work in them.
          You can toggle visibility for each repository.
        </p>
      </div>

      <div id="repos-list" class="card">
        <p class="text-secondary">Loading...</p>
      </div>
    </div>
  </main>
</Layout>

<style>
  .repo-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-md) 0;
    border-bottom: 1px solid var(--border-subtle);
  }

  .repo-row:last-child {
    border-bottom: none;
  }

  .repo-info {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .repo-name {
    font-weight: 500;
    font-family: var(--font-mono);
  }

  .repo-url {
    font-size: 0.75rem;
    color: var(--text-muted);
    font-family: var(--font-mono);
  }

  .visibility-toggle {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }
</style>

<script>
  type Repo = {
    id: string;
    name: string;
    remote_url: string | null;
    is_public: boolean;
  };

  async function loadRepos() {
    const container = document.getElementById('repos-list') as HTMLDivElement;

    try {
      const response = await fetch('/api/v1/admin/repos');
      const result = await response.json() as { data?: { repos: Repo[] }, error?: string };

      if (!response.ok) {
        throw new Error(result.error || 'Failed to load repositories');
      }

      const repos = result.data?.repos || [];

      if (repos.length === 0) {
        container.innerHTML = '<p class="text-secondary">No repositories tracked yet. They will appear here when team members start working.</p>';
        return;
      }

      container.innerHTML = repos.map((repo) => `
        <div class="repo-row" data-repo-id="${repo.id}">
          <div class="repo-info">
            <span class="repo-name">${repo.name}</span>
            <span class="repo-url">${repo.remote_url || '(local only)'}</span>
          </div>
          <div class="visibility-toggle">
            <label style="display: flex; align-items: center; gap: var(--space-xs); cursor: pointer; font-size: 0.875rem;">
              <input
                type="checkbox"
                ${repo.is_public ? 'checked' : ''}
                onchange="toggleVisibility('${repo.id}', this.checked)"
                style="width: 16px; height: 16px;"
              />
              <span class="text-secondary">Public</span>
            </label>
          </div>
        </div>
      `).join('');
    } catch (error) {
      container.innerHTML = `<p style="color: var(--accent-orange);">${error instanceof Error ? error.message : 'Failed to load repositories'}</p>`;
    }
  }

  async function toggleVisibility(repoId: string, isPublic: boolean) {
    try {
      const response = await fetch(`/api/v1/admin/repos/${repoId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_public: isPublic }),
      });

      if (!response.ok) {
        const result = await response.json() as { error?: string };
        throw new Error(result.error || 'Failed to update repository');
      }
    } catch (error) {
      alert(error instanceof Error ? error.message : 'Failed to update repository');
      loadRepos(); // Reload to reset state
    }
  }

  // Make function global
  (window as unknown as { toggleVisibility: typeof toggleVisibility }).toggleVisibility = toggleVisibility;

  // Load repos on page load
  loadRepos();
</script>
