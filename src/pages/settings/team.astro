---
import Layout from '@layouts/Layout.astro';
import { Header } from '@components/Header';
---

<Layout title="Team Settings">
  <Header client:load />

  <main class="container" style="padding-top: var(--space-xl); padding-bottom: var(--space-xl);">
    <div style="max-width: 600px; margin: 0 auto;">
      <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-xl);">
        <a href="/settings" class="text-muted" style="text-decoration: none;">‚Üê Back</a>
        <h1 style="font-size: 1.5rem;">Team Settings</h1>
      </div>

      <form id="team-form" class="card">
        <div style="margin-bottom: var(--space-lg);">
          <label
            for="team-name"
            style="display: block; margin-bottom: var(--space-sm); font-weight: 500;"
          >
            Team Name
          </label>
          <input
            type="text"
            id="team-name"
            name="name"
            placeholder="My Team"
            style="
              width: 100%;
              padding: var(--space-sm) var(--space-md);
              background: var(--bg-elevated);
              border: 1px solid var(--border-default);
              border-radius: var(--radius-sm);
              color: var(--text-primary);
              font-size: 1rem;
            "
          />
        </div>

        <div style="margin-bottom: var(--space-lg);">
          <label style="display: flex; align-items: center; gap: var(--space-sm); cursor: pointer;">
            <input
              type="checkbox"
              id="is-public"
              name="is_public"
              style="width: 18px; height: 18px;"
            />
            <span style="font-weight: 500;">Public Timeline</span>
          </label>
          <p class="text-muted" style="font-size: 0.75rem; margin-top: var(--space-xs); margin-left: 26px;">
            Allow anyone to view your team's activity without authentication
          </p>
        </div>

        <div style="margin-bottom: var(--space-lg);">
          <label
            for="stale-timeout"
            style="display: block; margin-bottom: var(--space-sm); font-weight: 500;"
          >
            Stale Session Timeout (hours)
          </label>
          <input
            type="number"
            id="stale-timeout"
            name="stale_timeout_hours"
            min="1"
            max="168"
            value="8"
            style="
              width: 100%;
              padding: var(--space-sm) var(--space-md);
              background: var(--bg-elevated);
              border: 1px solid var(--border-default);
              border-radius: var(--radius-sm);
              color: var(--text-primary);
              font-size: 1rem;
            "
          />
          <p class="text-muted" style="font-size: 0.75rem; margin-top: var(--space-xs);">
            Sessions without activity will be marked stale after this time
          </p>
        </div>

        <div style="margin-bottom: var(--space-lg);">
          <label
            for="new-password"
            style="display: block; margin-bottom: var(--space-sm); font-weight: 500;"
          >
            New Dashboard Password (optional)
          </label>
          <input
            type="password"
            id="new-password"
            name="dashboard_password"
            minlength="8"
            placeholder="Leave blank to keep current"
            style="
              width: 100%;
              padding: var(--space-sm) var(--space-md);
              background: var(--bg-elevated);
              border: 1px solid var(--border-default);
              border-radius: var(--radius-sm);
              color: var(--text-primary);
              font-size: 1rem;
            "
          />
        </div>

        <button type="submit" class="btn btn-primary" style="width: 100%;">
          Save Changes
        </button>

        <p id="status-message" style="margin-top: var(--space-md); text-align: center; display: none;"></p>
      </form>
    </div>
  </main>
</Layout>

<script>
  const form = document.getElementById('team-form') as HTMLFormElement;
  const statusMessage = document.getElementById('status-message') as HTMLParagraphElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const data: Record<string, unknown> = {};

    const name = formData.get('name');
    if (name) data.name = name;

    data.is_public = formData.get('is_public') === 'on';

    const staleTimeout = formData.get('stale_timeout_hours');
    if (staleTimeout) data.stale_timeout_hours = parseInt(staleTimeout as string, 10);

    const password = formData.get('dashboard_password');
    if (password) data.dashboard_password = password;

    try {
      const response = await fetch('/api/v1/admin/team', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      const result = await response.json() as { data?: { message: string }, error?: string };

      if (!response.ok) {
        throw new Error(result.error || 'Failed to save');
      }

      statusMessage.textContent = 'Settings saved successfully!';
      statusMessage.style.color = 'var(--accent-green)';
      statusMessage.style.display = 'block';

      setTimeout(() => {
        statusMessage.style.display = 'none';
      }, 3000);
    } catch (error) {
      statusMessage.textContent = error instanceof Error ? error.message : 'Failed to save';
      statusMessage.style.color = 'var(--accent-orange)';
      statusMessage.style.display = 'block';
    }
  });
</script>
