---
import Layout from '@layouts/Layout.astro';
import { Header } from '@components/Header';
---

<Layout title="My Account">
  <Header client:load />

  <main class="container" style="padding-top: var(--space-xl); padding-bottom: var(--space-xl);">
    <div style="max-width: 600px; margin: 0 auto;">
      <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-xl);">
        <a href="/settings" class="text-muted" style="text-decoration: none;">‚Üê Back</a>
        <h1 style="font-size: 1.5rem;">My Account</h1>
      </div>

      <!-- Loading state -->
      <div id="loading-state" class="card" style="text-align: center; padding: var(--space-xl);">
        <p class="text-secondary">Loading...</p>
      </div>

      <!-- Error state -->
      <div id="error-state" class="card" style="text-align: center; padding: var(--space-xl); display: none;">
        <p class="text-secondary" id="error-message">Failed to load account details</p>
        <a href="/join" class="btn btn-primary" style="margin-top: var(--space-md);">Sign In</a>
      </div>

      <!-- Account details -->
      <div id="account-section" style="display: none;">
        <div class="card" style="margin-bottom: var(--space-lg);">
          <h2 style="font-size: 1.125rem; margin-bottom: var(--space-lg);">Account Details</h2>

          <div style="margin-bottom: var(--space-lg);">
            <label style="display: block; margin-bottom: var(--space-xs); font-weight: 500; font-size: 0.875rem;">Name</label>
            <p id="user-name" class="text-secondary" style="font-size: 1rem;">-</p>
          </div>

          <div style="margin-bottom: var(--space-lg);">
            <label style="display: block; margin-bottom: var(--space-xs); font-weight: 500; font-size: 0.875rem;">Email</label>
            <p id="user-email" class="text-secondary" style="font-size: 1rem;">-</p>
          </div>

          <div style="margin-bottom: var(--space-lg);">
            <label style="display: block; margin-bottom: var(--space-xs); font-weight: 500; font-size: 0.875rem;">Role</label>
            <p id="user-role" class="text-secondary" style="font-size: 1rem;">-</p>
          </div>

          <div>
            <label style="display: block; margin-bottom: var(--space-xs); font-weight: 500; font-size: 0.875rem;">Team</label>
            <p id="team-name" class="text-secondary" style="font-size: 1rem;">-</p>
          </div>
        </div>

        <div class="card" style="margin-bottom: var(--space-lg);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md);">
            <div>
              <h2 style="font-size: 1.125rem; margin-bottom: var(--space-xs);">Your User Token</h2>
              <p class="text-muted" style="font-size: 0.75rem;">
                Use this token to configure the Claude Code plugin
              </p>
            </div>
            <button type="button" id="copy-token-btn" style="
              background: none;
              border: 1px solid var(--border-default);
              color: var(--text-secondary);
              padding: 4px 8px;
              border-radius: var(--radius-sm);
              font-size: 0.75rem;
              cursor: pointer;
            ">
              Copy
            </button>
          </div>
          <input
            type="text"
            id="user-token"
            readonly
            style="
              width: 100%;
              padding: var(--space-sm) var(--space-md);
              background: var(--bg-primary);
              border: 1px solid var(--border-subtle);
              border-radius: var(--radius-sm);
              color: var(--text-primary);
              font-family: var(--font-mono);
              font-size: 0.875rem;
            "
          />
        </div>

        <div style="background: var(--bg-surface); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: var(--space-lg);">
          <h3 style="font-size: 1rem; margin-bottom: var(--space-md);">Plugin Configuration</h3>
          <p class="text-secondary" style="font-size: 0.875rem; margin-bottom: var(--space-md);">
            To configure the Claude Code plugin, run this command in any Claude Code session:
          </p>
          <code style="
            display: block;
            background: var(--bg-elevated);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
          ">/overlap:config</code>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  const loadingState = document.getElementById('loading-state') as HTMLDivElement;
  const errorState = document.getElementById('error-state') as HTMLDivElement;
  const accountSection = document.getElementById('account-section') as HTMLDivElement;
  const userName = document.getElementById('user-name') as HTMLParagraphElement;
  const userEmail = document.getElementById('user-email') as HTMLParagraphElement;
  const userRole = document.getElementById('user-role') as HTMLParagraphElement;
  const teamName = document.getElementById('team-name') as HTMLParagraphElement;
  const userToken = document.getElementById('user-token') as HTMLInputElement;
  const copyTokenBtn = document.getElementById('copy-token-btn') as HTMLButtonElement;

  async function loadProfile() {
    try {
      const response = await fetch('/api/v1/me');

      if (!response.ok) {
        throw new Error('Not authenticated');
      }

      const result = await response.json() as {
        data: {
          user: {
            id: string;
            name: string;
            email: string | null;
            role: string;
            user_token: string | null;
          };
          team: {
            id: string;
            name: string;
          };
        }
      };

      // Populate the UI
      userName.textContent = result.data.user.name;
      userEmail.textContent = result.data.user.email || 'Not set';
      userRole.textContent = result.data.user.role === 'admin' ? 'Admin' : 'Member';
      teamName.textContent = result.data.team.name;
      userToken.value = result.data.user.user_token || '';

      // Show account section
      loadingState.style.display = 'none';
      accountSection.style.display = 'block';

    } catch (error) {
      console.error('Failed to load profile:', error);
      loadingState.style.display = 'none';
      errorState.style.display = 'block';
    }
  }

  // Copy token handler
  copyTokenBtn?.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(userToken.value);
      copyTokenBtn.textContent = 'Copied!';
      setTimeout(() => {
        copyTokenBtn.textContent = 'Copy';
      }, 2000);
    } catch (err) {
      userToken.select();
      document.execCommand('copy');
      copyTokenBtn.textContent = 'Copied!';
      setTimeout(() => {
        copyTokenBtn.textContent = 'Copy';
      }, 2000);
    }
  });

  loadProfile();
</script>
