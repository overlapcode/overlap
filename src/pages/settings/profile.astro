---
import Layout from '@layouts/Layout.astro';
import { Header } from '@components/Header';
---

<Layout title="Collector Setup">
  <Header userName="Dashboard" client:load />

  <main class="container" style="padding-top: var(--space-xl); padding-bottom: var(--space-xl);">
    <div style="width: 100%; max-width: 600px; margin: 0 auto;">
      <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-xl);">
        <a href="/settings" class="text-muted" style="text-decoration: none;">← Back</a>
        <h1 style="font-size: 1.5rem;">Collector Setup</h1>
      </div>

      <!-- Instance URL Section -->
      <div class="card" style="margin-bottom: var(--space-lg);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-sm);">
          <label style="font-weight: 500;">Instance URL</label>
          <button type="button" id="copy-url-btn" style="
            background: none;
            border: 1px solid var(--border-default);
            color: var(--text-secondary);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            cursor: pointer;
          ">
            Copy
          </button>
        </div>
        <input
          type="text"
          id="instance-url"
          readonly
          style="
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 0.875rem;
          "
        />
        <p class="text-muted" style="font-size: 0.75rem; margin-top: var(--space-xs);">
          Use this URL when running <code style="background: var(--bg-elevated); padding: 2px 4px; border-radius: 2px;">overlap join</code>
        </p>
      </div>

      <!-- Installation Instructions -->
      <div style="background: var(--bg-surface); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: var(--space-lg);">
        <h3 style="font-size: 1rem; margin-bottom: var(--space-lg);">Setting Up the Tracer</h3>

        <div style="margin-bottom: var(--space-lg);">
          <p class="text-secondary" style="font-size: 0.875rem; margin-bottom: var(--space-sm);">
            <strong style="color: var(--text-primary);">1. Install the tracer</strong>
          </p>
          <div style="display: flex; gap: var(--space-sm); align-items: center;">
            <code id="install-cmd" style="
              flex: 1;
              display: block;
              background: var(--bg-elevated);
              padding: var(--space-sm) var(--space-md);
              border-radius: var(--radius-sm);
              font-size: 0.875rem;
              overflow-x: auto;
            ">curl -fsSL https://overlap.sh/install.sh | sh</code>
            <button type="button" class="copy-btn" data-target="install-cmd" style="
              background: none;
              border: 1px solid var(--border-default);
              color: var(--text-secondary);
              padding: 4px 8px;
              border-radius: var(--radius-sm);
              font-size: 0.75rem;
              cursor: pointer;
              flex-shrink: 0;
            ">Copy</button>
          </div>
        </div>

        <div style="margin-bottom: var(--space-lg);">
          <p class="text-secondary" style="font-size: 0.875rem; margin-bottom: var(--space-sm);">
            <strong style="color: var(--text-primary);">2. Connect to your team</strong>
          </p>
          <code style="
            display: block;
            background: var(--bg-elevated);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
          ">overlap join</code>
          <p class="text-muted" style="font-size: 0.75rem; margin-top: var(--space-xs);">
            You'll be prompted for the instance URL (above) and your user token (from /join page).
          </p>
        </div>

        <div>
          <p class="text-secondary" style="font-size: 0.875rem; margin-bottom: var(--space-sm);">
            <strong style="color: var(--text-primary);">3. Verify it's working</strong>
          </p>
          <code style="
            display: block;
            background: var(--bg-elevated);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
          ">overlap status</code>
        </div>
      </div>

      <!-- New Member Section -->
      <div class="card" style="margin-top: var(--space-lg);">
        <h3 style="font-size: 1rem; margin-bottom: var(--space-md);">Adding New Members</h3>
        <p class="text-secondary" style="font-size: 0.875rem; margin-bottom: var(--space-md);">
          New team members can join via the <a href="/join" style="color: var(--accent-blue);">/join</a> page using the team join code.
          They'll receive a personal user token to configure their tracer.
        </p>
        <a href="/settings/team" class="btn btn-secondary" style="display: inline-block;">
          View Join Code →
        </a>
      </div>
    </div>
  </main>
</Layout>

<script>
  const instanceUrl = document.getElementById('instance-url') as HTMLInputElement;
  const copyUrlBtn = document.getElementById('copy-url-btn') as HTMLButtonElement;

  // Set instance URL to current origin
  instanceUrl.value = window.location.origin;

  // Copy URL handler
  copyUrlBtn?.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(instanceUrl.value);
      copyUrlBtn.textContent = 'Copied!';
      setTimeout(() => {
        copyUrlBtn.textContent = 'Copy';
      }, 2000);
    } catch (err) {
      instanceUrl.select();
      document.execCommand('copy');
      copyUrlBtn.textContent = 'Copied!';
      setTimeout(() => {
        copyUrlBtn.textContent = 'Copy';
      }, 2000);
    }
  });

  // Copy button handlers for code blocks
  document.querySelectorAll('.copy-btn').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const targetId = (btn as HTMLButtonElement).dataset.target;
      if (!targetId) return;

      const codeEl = document.getElementById(targetId);
      if (!codeEl) return;

      const text = codeEl.textContent || '';

      try {
        await navigator.clipboard.writeText(text);
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => {
          btn.textContent = originalText;
        }, 2000);
      } catch (err) {
        // Fallback
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        btn.textContent = 'Copied!';
        setTimeout(() => {
          btn.textContent = 'Copy';
        }, 2000);
      }
    });
  });
</script>
